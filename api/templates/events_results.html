<!-- events_results.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles_events.css') }}">
    <title>Event Search Results</title>
</head>

<body>
    <div id="header">
        <h1>My Music Map</h1>
        <nav id="navbar">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/support">Support</a></li>
                <li><a href="/about">About Us</a></li>
                <li><a href="/liked_events">
                    <img src="static/liked-heart.png" alt="Heart" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">
                    Saved Events</a>
                </li> 
            </ul>
        </nav>    
    </div>

    <div id ="table-heading">
        <h2>Our Handpicked Music Events for You in {{ city }}!</h2>
        <p>click on any event for more information.</p>
    </div>

    {% if events %}
    <table id="events-table">
        <tr>
            <th>Event Cover</th>
            {%for key in events[0].keys() if key not in ['image_url', 'url', 'id']%}
                <th>{{ key.replace('_', ' ').title() }}</td>
            {% endfor %}
        </tr>
        {% for event in events%}
        <tr>
            <td class="image-column"><img src="{{ event.image_url }}" alt="Event cover"></td>
            <td><a href="{{ event.url }}" target="_blank">{{ event.name }}</a></td>
            <td>{{ event.event_date }}</td>
            <td>{{ event.event_time }}</td>
            <td>{{ event.city }}</td>
            <td>{{ event.country }}</td>
            <td>{{ event.venue_name }}</td>
            <td>{{ event.price_range }}</td>
            <td><button class='like-button' data-event="{{ event['id'] }}"></button></td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
        <p>No events found.</p>
    {% endif %}

    <br>
    <form action="/homepage">
        <input type="submit" value="Return to homepage", class="homepage-button">
    </form>

</body>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var likeButtons = document.querySelectorAll('.like-button');
        var likedEvents = {{ liked_events|tojson|safe }};
        likeButtons.forEach(function (button) {
            var eventID = button.getAttribute('data-event');

            // Check if the event is in the list of liked events
            if (likedEvents.includes(eventID)) {
                button.classList.add('liked');
            }

            button.addEventListener('click', function () {
                if (button.classList.contains('liked')) {
                    // Unlike
                    button.classList.remove('liked');
                    sendUnlikeRequest(eventID);
                } else {
                    // Like
                    button.classList.add('liked');
                    sendLikeRequest(eventID);
                }
            });
        });

        function sendLikeRequest(eventID) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/like', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send('eventID=' + encodeURIComponent(eventID));
        }

        function sendUnlikeRequest(eventID) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/unlike', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send('eventID=' + encodeURIComponent(eventID));
        }
    });
</script>

</html>
